<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}} 'unsafe-inline'; script-src 'nonce-{{nonce}}'; img-src {{cspSource}} https:;">
  <link href="{{styleUri}}" rel="stylesheet">
  <link href="{{codiconsUri}}" rel="stylesheet">
  <title>CodeCraft AI Mentor</title>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar with badges -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Your Learning Journey</h2>
      </div>
      
      <div class="badges-container">
        <div class="badge completed" data-tooltip="Solved 5+ debugging challenges">
          <div class="badge-icon">
            <svg class="check-icon" viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
            </svg>
          </div>
          <span class="badge-name">Debug Hero</span>
        </div>
        <div class="badge completed" data-tooltip="Mastered loop concepts">
          <div class="badge-icon">
            <svg class="check-icon" viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
            </svg>
          </div>
          <span class="badge-name">Loop Ninja</span>
        </div>
        <div class="badge completed" data-tooltip="Completed API integration exercises">
          <div class="badge-icon">
            <svg class="check-icon" viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
            </svg>
          </div>
          <span class="badge-name">API Master</span>
        </div>
        <div class="badge completed" data-tooltip="Demonstrated OOP principles">
          <div class="badge-icon">
            <svg class="check-icon" viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
            </svg>
          </div>
          <span class="badge-name">OOP Wizard</span>
        </div>
        <div class="badge" data-tooltip="Complete 3 test-driven exercises to unlock">
          <div class="badge-icon">
            <svg class="circle-icon" viewBox="0 0 24 24" width="16" height="16">
              <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"></circle>
            </svg>
          </div>
          <span class="badge-name">Test Champion</span>
        </div>
        <div class="badge" data-tooltip="Complete 5 algorithm challenges to unlock">
          <div class="badge-icon">
            <svg class="circle-icon" viewBox="0 0 24 24" width="16" height="16">
              <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"></circle>
            </svg>
          </div>
          <span class="badge-name">Algo Expert</span>
        </div>
      </div>
      
      <div class="progress-container">
        <h3>Weekly Goals</h3>
        <div class="progress-label">
          <span>Learning Progress</span>
          <span>70%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 70%"></div>
        </div>
        <div class="progress-label">
          <span>Challenges Completed</span>
          <span>3/5</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 60%"></div>
        </div>
      </div>
    </aside>

    <!-- Main content area -->
    <main class="main-content">
      <div class="tabs">
        <button class="tab-button active" data-tab="chat">
          <i class="codicon codicon-comment"></i> Chat
        </button>
        <button class="tab-button" data-tab="journal">
          <i class="codicon codicon-book"></i> Learning Journal
        </button>
      </div>

      <!-- Chat tab content -->
      <div class="tab-content active" id="chat-tab">
        <div class="chat-container">
          <div id="api-key-warning" class="api-key-warning hidden">
            <p><i class="codicon codicon-warning"></i> Hugging Face API token not set. Please set your API token to use the AI features.</p>
            <button id="set-api-key-btn">Set API Token</button>
          </div>
          
          <div class="messages">
            <div class="message ai">
              <div class="message-content">
                <p>Hello! I'm your AI coding mentor powered by Hugging Face. I'm here to help you learn programming concepts through guided discovery rather than direct answers.</p>
                <p>What would you like to explore today?</p>
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
          
          <div class="error-explainer hidden">
            <button id="explain-error-btn">
              <i class="codicon codicon-debug"></i>
              Explain This Error
            </button>
          </div>

          <div class="settings-row">
            <div class="mode-toggle">
              <span>Response Mode:</span>
              <div class="toggle-container">
                <button class="toggle-button active" data-mode="text">
                  <i class="codicon codicon-text-size"></i> Text Guide
                </button>
                <button class="toggle-button" data-mode="visual">
                  <i class="codicon codicon-symbol-color"></i> Visual Metaphor
                </button>
              </div>
            </div>

            <div class="theme-selector">
              <span>Theme:</span>
              <div class="dropdown">
                <button id="theme-dropdown-btn" class="dropdown-button">
                  <span id="current-theme">Default</span>
                  <i class="codicon codicon-chevron-down"></i>
                </button>
                <div class="dropdown-content">
                  <div class="theme-option" data-theme="default">
                    <div class="theme-preview default-theme"></div>
                    <span>Default</span>
                  </div>
                  <div class="theme-option" data-theme="ocean">
                    <div class="theme-preview ocean-theme"></div>
                    <span>Ocean</span>
                  </div>
                  <div class="theme-option" data-theme="forest">
                    <div class="theme-preview forest-theme"></div>
                    <span>Forest</span>
                  </div>
                  <div class="theme-option" data-theme="sunset">
                    <div class="theme-preview sunset-theme"></div>
                    <span>Sunset</span>
                  </div>
                  <div class="theme-option" data-theme="midnight">
                    <div class="theme-preview midnight-theme"></div>
                    <span>Midnight</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="socratic-level">
            <span>Socratic Strictness:</span>
            <div class="toggle-container">
              <button class="socratic-button" data-level="strict">
                <i class="codicon codicon-question"></i> Strict
              </button>
              <button class="socratic-button active" data-level="balanced">
                <i class="codicon codicon-combine"></i> Balanced
              </button>
              <button class="socratic-button" data-level="flexible">
                <i class="codicon codicon-lightbulb"></i> Flexible
              </button>
            </div>
          </div>

          <!-- Make sure the icon is properly defined in the button -->
          <div class="input-container">
            <textarea id="message-input" placeholder="Ask me anything about coding..."></textarea>
            <button id="send-button" title="Send message">
              <span class="arrow-up">↑</span>
            </button>
          </div>
          
          <div class="exp-container">
            <div class="exp-label">
              <span>Experience</span>
              <span id="exp-value">0 XP</span>
            </div>
            <div class="exp-bar">
              <div id="exp-fill" class="exp-fill" style="width: 0%"></div>
            </div>
            <div class="exp-level">
              <span>Level <span id="current-level">1</span></span>
              <span id="level-progress">0/100</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Learning Journal tab content -->
      <div class="tab-content" id="journal-tab">
        <div class="journal-container">
          <div class="journal-header">
            <h2>Learning Analytics</h2>
            <div class="time-filter">
              <select id="time-filter">
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="all">All Time</option>
              </select>
            </div>
          </div>

          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-title">Errors Resolved</div>
              <div class="metric-value">12 <span class="trend up">↑ 40%</span></div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Concepts Learned</div>
              <div class="metric-value">8 <span class="trend up">↑ 25%</span></div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Practice Time</div>
              <div class="metric-value">5.2h <span class="trend up">↑ 15%</span></div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Code Quality</div>
              <div class="metric-value">B+ <span class="trend up">↑ 10%</span></div>
            </div>
          </div>

          <div class="timeline">
            <h3>Recent Activity</h3>
            <div class="timeline-item">
              <div class="timeline-date">Today, 10:32 AM</div>
              <div class="timeline-content">
                <div class="timeline-title">Learned about Async/Await</div>
                <div class="timeline-description">Discussed JavaScript asynchronous programming patterns</div>
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-date">Yesterday, 3:45 PM</div>
              <div class="timeline-content">
                <div class="timeline-title">Fixed TypeError in React Component</div>
                <div class="timeline-description">Resolved issue with props validation in functional component</div>
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-date">May 15, 2:20 PM</div>
              <div class="timeline-content">
                <div class="timeline-title">Completed Array Methods Challenge</div>
                <div class="timeline-description">Successfully implemented map, filter, and reduce functions</div>
              </div>
            </div>
          </div>

          <div class="study-plan">
            <h3>Recommended Study Plan</h3>
            <div class="checklist">
              <div class="checklist-item">
                <input type="checkbox" id="item1">
                <label for="item1">Review Promise chaining vs async/await</label>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="item2">
                <label for="item2">Practice error handling in asynchronous code</label>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="item3" checked>
                <label for="item3">Complete the loop optimization exercise</label>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="item4">
                <label for="item4">Learn about React useEffect cleanup functions</label>
              </div>
              <div class="checklist-item">
                <input type="checkbox" id="item5">
                <label for="item5">Implement a basic unit test for your current project</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script nonce="{{nonce}}">
    (function() {
      const vscode = acquireVsCodeApi();
      
      // DOM Elements
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const messagesContainer = document.querySelector('.messages');
      const explainErrorBtn = document.getElementById('explain-error-btn');
      const errorExplainer = document.querySelector('.error-explainer');
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      const toggleButtons = document.querySelectorAll('.toggle-button');
      const socraticButtons = document.querySelectorAll('.socratic-button');
      const apiKeyWarning = document.getElementById('api-key-warning');
      const setApiKeyBtn = document.getElementById('set-api-key-btn');
      const themeDropdownBtn = document.getElementById('theme-dropdown-btn');
      const themeOptions = document.querySelectorAll('.theme-option');
      const currentThemeText = document.getElementById('current-theme');
      
      // Initialize with stored state
      const state = vscode.getState() || { 
        messages: [],
        activeTab: 'chat',
        responseMode: 'text',
        socraticLevel: 'balanced',
        exp: 0,
        level: 1,
        expToNextLevel: 100,
        theme: 'default'
      };
      
      // Apply saved theme on load
      if (state.theme) {
        applyTheme(state.theme);
      }
      
      // Check API key status on load
      vscode.postMessage({
        command: 'checkApiKey'
      });
      
      // Handle sending messages
      function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        
        // Add message to UI
        addMessageToUI(text, true);
        
        // Send to extension
        vscode.postMessage({
          command: 'sendMessage',
          text: text
        });
        
        // Clear input
        messageInput.value = '';

        // Update experience
        updateExperience();
      }
      
      // Add message to UI
      function addMessageToUI(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'message user' : 'message ai';
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Process markdown-like syntax for code blocks
        let processedText = text;
        if (!isUser) {
          // Replace \`\`\`code\`\`\` with styled code blocks
          processedText = text.replace(/\`\`\`([\s\S]*?)\`\`\`/g, '<pre><code>$1</code></pre>');
          
          // Replace `inline code` with styled inline code
          processedText = processedText.replace(/`([^`]+)`/g, '<code>$1</code>');
        }
        
        messageDiv.innerHTML = `
          <div class="message-content">
            ${isUser ? `<p>${text}</p>` : processedText}
          </div>
          <div class="message-time">${time}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Update state
        state.messages.push({
          text,
          isUser,
          timestamp: new Date().toISOString()
        });
        vscode.setState(state);
      }
      
      // Update experience
      function updateExperience() {
        // Only add exp for user messages
        const expGain = 10;
        state.exp += expGain;
        
        // Calculate level and progress
        const level = Math.floor(state.exp / state.expToNextLevel) + 1;
        const expInCurrentLevel = state.exp % state.expToNextLevel;
        const progressPercent = (expInCurrentLevel / state.expToNextLevel) * 100;
        
        // Update level if changed
        if (level !== state.level) {
          state.level = level;
          // Show level up notification
          const levelUpDiv = document.createElement('div');
          levelUpDiv.className = 'level-up-notification';
          levelUpDiv.textContent = `Level Up! You're now level ${level}`;
          document.body.appendChild(levelUpDiv);
          
          // Remove notification after animation
          setTimeout(() => {
            levelUpDiv.classList.add('fade-out');
            setTimeout(() => {
              document.body.removeChild(levelUpDiv);
            }, 500);
          }, 3000);
        }
        
        // Update UI
        document.getElementById('exp-value').textContent = `${state.exp} XP`;
        document.getElementById('exp-fill').style.width = `${progressPercent}%`;
        document.getElementById('current-level').textContent = state.level;
        document.getElementById('level-progress').textContent = `${expInCurrentLevel}/${state.expToNextLevel}`;
        
        // Save state
        vscode.setState(state);
      }

      // Apply theme
      function applyTheme(themeName) {
        // Remove all theme classes
        document.body.classList.remove('theme-default', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-midnight');
        
        // Add selected theme class
        document.body.classList.add(`theme-${themeName}`);
        
        // Update current theme text
        currentThemeText.textContent = themeName.charAt(0).toUpperCase() + themeName.slice(1);
        
        // Save theme in state
        state.theme = themeName;
        vscode.setState(state);
      }
      
      // Event Listeners
      sendButton.addEventListener('click', sendMessage);
      
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      explainErrorBtn.addEventListener('click', () => {
        vscode.postMessage({
          command: 'explainError'
        });
      });
      
      setApiKeyBtn.addEventListener('click', () => {
        vscode.postMessage({
          command: 'setHuggingFaceApiToken'
        });
      });
      
      // Theme dropdown toggle
      themeDropdownBtn.addEventListener('click', () => {
        const dropdownContent = themeDropdownBtn.nextElementSibling;
        dropdownContent.classList.toggle('show');
      });
      
      // Close dropdown when clicking outside
      window.addEventListener('click', (e) => {
        if (!e.target.matches('.dropdown-button') && !e.target.matches('.codicon-chevron-down')) {
          const dropdowns = document.querySelectorAll('.dropdown-content');
          dropdowns.forEach(dropdown => {
            if (dropdown.classList.contains('show')) {
              dropdown.classList.remove('show');
            }
          });
        }
      });
      
      // Theme selection
      themeOptions.forEach(option => {
        option.addEventListener('click', () => {
          const themeName = option.getAttribute('data-theme');
          applyTheme(themeName);
          
          // Close dropdown
          option.closest('.dropdown-content').classList.remove('show');
        });
      });
      
      // Tab switching
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tab = button.dataset.tab;
          
          // Update active tab
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Show corresponding content
          tabContents.forEach(content => content.classList.remove('active'));
          document.getElementById(`${tab}-tab`).classList.add('active');
          
          // Update state
          state.activeTab = tab;
          vscode.setState(state);
          
          // Notify extension if switching to learning journal
          if (tab === 'journal') {
            vscode.postMessage({
              command: 'openLearningJournal'
            });
          }
        });
      });
      
      // Toggle response mode
      toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
          const mode = button.dataset.mode;
          
          // Update active button
          toggleButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Update state
          state.responseMode = mode;
          vscode.setState(state);
          
          // Notify extension
          vscode.postMessage({
            command: 'toggleMode',
            mode: mode
          });
        });
      });
      
      // Socratic strictness toggle
      socraticButtons.forEach(button => {
        button.addEventListener('click', () => {
          const level = button.dataset.level;
          
          // Update active button
          socraticButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Update state
          state.socraticLevel = level;
          vscode.setState(state);
          
          // Notify extension
          vscode.postMessage({
            command: 'setSocraticLevel',
            level: level
          });
        });
      });
      
      // Handle messages from extension
      window.addEventListener('message', event => {
        const message = event.data;
        
        switch (message.command) {
          case 'receiveMessage':
            addMessageToUI(message.message.text, message.message.isUser);
            break;
            
          case 'updateDiagnostics':
            if (message.hasErrors) {
              errorExplainer.classList.remove('hidden');
            } else {
              errorExplainer.classList.add('hidden');
            }
            break;
            
          case 'explainError':
            // Add the error explanation as an AI message
            const errorText = `I noticed an error in your code: "${message.error.message}" at line ${message.error.line}, column ${message.error.column}. Let me help you understand what's happening...`;
            addMessageToUI(errorText, false);
            break;
            
          case 'showLearningJournal':
            // Switch to learning journal tab
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('[data-tab="journal"]').classList.add('active');
            document.getElementById('journal-tab').classList.add('active');
            break;
            
          case 'apiKeyStatus':
            if (message.status === 'missing') {
              apiKeyWarning.classList.remove('hidden');
            } else {
              apiKeyWarning.classList.add('hidden');
            }
            break;
        }
      });

      // Initialize exp bar from state
      if (state.exp !== undefined) {
        const level = Math.floor(state.exp / state.expToNextLevel) + 1;
        const expInCurrentLevel = state.exp % state.expToNextLevel;
        const progressPercent = (expInCurrentLevel / state.expToNextLevel) * 100;
        
        document.getElementById('exp-value').textContent = `${state.exp} XP`;
        document.getElementById('exp-fill').style.width = `${progressPercent}%`;
        document.getElementById('current-level').textContent = state.level || 1;
        document.getElementById('level-progress').textContent = `${expInCurrentLevel}/${state.expToNextLevel}`;
      }
    })();
  </script>
</body>
</html>

